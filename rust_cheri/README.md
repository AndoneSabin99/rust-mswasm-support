# Rust to MS-Wasm (experimental Rust fork with CHERI support)

In this method an experimental version of Rust compiler is used for compiling Rust to MS-Wasm. This fork of RUst integrates CHERI capabilities inside the LLVM-IR generated by rustc. At the moment, this fork is designed for compiling to Morello (CHERI on ARM), so trying to experiment with this method to target MS-Wasm requires caution since it is not required that it would work.

## Setup

Experimenting with this approach requires [this](https://github.com/kent-weak-memory/rust) speficic fork of Rust. Make sure to follow the instructions on their repository for a correct installation. The compilation process in this case has been designed as follows:

```
Rust -- via rustc with CHERI support --> LLVM-IR -- via clang with MS-Wasm support --> MS-Wasm
```

## Compiling and Executing

First, compile Rust code into LLVM-IR with target aarch64-unknown-freebsd-purecap, after that take the generated .ll file and with Clang with MS-Wasm support generate the MS-Wasm binary file. Note: this method is not guaranteed to work. In fact, all examples here cannot generate an executable due to issues.

```
rustc --emit=llvm-ir <filename>.rs -o <filename>.ll --target aarch64-unknown-freebsd-purecap -C linker=<linker_path>
clang -O3 --target=wasm32-wasi --sysroot=<mswasm-wasi-libc/sysroot_path> <filename>.ll -o <filename>.wasm
```
