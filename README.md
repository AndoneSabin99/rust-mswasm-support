# rust-mswasm-support
This repository contains some Rust source code files which have been used for experimenting with different methods in compiling Rust to MS-Wasm (Memory Safe Web Assembly). MS-Wasm is a variant of Wasm which introduces new features for granting safety inside memory. These features can be implemented using CHERI capabilities. More details about MS-Wasm can be found [here](https://github.com/PLSysSec/ms-wasm).

Note: this repository is only intended to be a support for initial work, not an actual complete implementation of Rust with MS-Wasm support!

## Setup
This work has been realized inside an Ubuntu 22.04.3 LTS distro on WSL. Thus, it is recommended to use either a Linux OS or a Linux distro for WSL, in the case it is desired to use a Windows OS. Other platforms, like MAC OS, have not been used, so it is not guaranteed that what is written in this repository also applies to these other platforms.

## Toolchains
Compiling Rust to MS-Wasm requires some tools to be installed on the machine. First of all, it is necessary to acquire a Rust compiler with `wasm32-wasi` target installed. This can be achieved by either using [rustup](https://rustup.rs/) or building the Rust compiler by following the instructions on the official [Rust project repository](https://github.com/rust-lang/rust). The only method that instead uses another fork of Rust is the second method, which uses a fork of the Rust compiler with CHERI support (see that directory instructions for more details). Once installed the Rust compiler, install the following tools:

* [mswasm-llvm](https://github.com/PLSysSec/mswasm-llvm): source code for the compiler from C to MS-Wasm bytecode. It is an extension of the [CHERI fork of LLVM](https://github.com/CTSRD-CHERI/llvm-project) with modifications to produce MSWasm bytecode. Since we want to generate MS-Wasm bytecode from Rust code, this Clang compiler is used as a linker.
* [mswasm-wasi-libc](https://github.com/PLSysSec/mswasm-wasi-libc): source code for supporting compilation of executables to MS-Wasm bytecode. Consists of WASI-libc with modifications to support MSWasm bytecode. In the case of Rust compilation, it is used since `wasm32-wasi` target requires the 'wasi-root'.
* [rWasm](https://github.com/secure-foundations/rWasm/tree/mswasm): source code for a AOT compiler from MS-Wasm bytecode. Consists of rWasm with modifications to support compiling from MSWasm bytecode. It is used to generate executable files from MS-Wasm bytecode.
* [mswasm-wabt](https://github.com/PLSysSec/mswasm-wabt): source code for `wasm2wat` utility with MS-Wasm support. Consists of a fork of [WABT](https://github.com/WebAssembly/wabt) partially modified to work on MS-Wasm bytecode. It converts MS-Wasm binaries into a readable text format. While not mandatory for the compilation process, it can be useful for debugging.

Some other tools may be required for testing with the approaches presented here. See the method directories for more details.

## Repository structure
For each one of these methods there is one directory that contains some files used for exploration, instructions for setting up the tools needed for the compilation and commands used for that specific method for the compilation process. Overall, the approaches used for exploring the compilation process from Rust to MS-Wasm are these:


* rust_mswasm: Compiling Rust code directly to MS-Wasm using the rustc compiler. All the above tools have been used and also more instructions and commands are presented inside its dedicated directory
* rust_cheri: Compiling Rust code to MS-Wasm by using a fork of Rust with CHERI support. Instructions are presented inside the method directory. Note that since it is an experimental fork, some functionalities may not work properly!
* rust_c: Compiling Rust code to MS-Wasm by using C as an intermediate step. This consists in two compilation steps: first Rust code is transpiled into C code, then that C code is compiled into MS-Wasm bytecode.
* rust_wasm2c: Compiling Rust code to C code and then to MS-Wasm by using wasm2c. The steps for this compilation process are: Rust --> Wasm --> C --> MS-Wasm. Note that this method can generate MS-Wasm binaries but it is not guaranteed to be correctly converted into executables via rWasm!
* rust_llvm-cbe: Compiling Rust code to C code and then to MS-Wasm by using llvm-cbe. The steps for this compilation process are: Rust --> LLVM-IR --> C --> MS-Wasm. This method is not guaranteed to be functional due to differences between LLVM-IR generated by Rust and the one generated by LLVM-IR!

